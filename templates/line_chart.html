{% extends "base.html" %}

{% block title %}Line Chart – IoT Dashboard{% endblock %}

{% block content %}
  <h2>Temperature Trends Over Time</h2>
  <p>This chart displays temperature readings from IoT sensors (SQLite database).</p>

  <!-- Controls -->
  <form id="filters" class="controls" onsubmit="event.preventDefault(); fetchAndRender();">
    <label>
      From:
      <input id="start" type="datetime-local">
    </label>
    <label>
      To:
      <input id="end" type="datetime-local">
    </label>
    <button type="submit">Apply</button>
    <button type="button" id="refreshBtn">Refresh</button>
  </form>

  <div class="chart-container" style="max-width: 900px; margin: 14px auto;">
    <canvas id="lineChart"></canvas>
  </div>
{% endblock %}

{% block scripts %}
<script>
  let lineChart;  // keep a reference so we can update it

  function buildUrl() {
    const start = document.getElementById('start').value;
    const end   = document.getElementById('end').value;

    const params = new URLSearchParams();
    if (start) params.set('start', start);
    if (end)   params.set('end', end);

    return params.toString()
      ? `/api/line-data?${params.toString()}`
      : `/api/line-data`;
  }

  async function fetchAndRender() {
    const res  = await fetch(buildUrl());
    const data = await res.json();

    const ctx = document.getElementById('lineChart').getContext('2d');

    if (lineChart) {
      // update existing chart
      lineChart.data.labels = data.labels;
      lineChart.data.datasets[0].data = data.datasets[0].data;
      lineChart.update();
      return;
    }

    // create chart first time
    lineChart = new Chart(ctx, {
      type: 'line',
      data,
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true, position: 'top' },
          title:  { display: true, text: 'Temperature Monitoring – 24 Hour Period' }
        },
        elements: { point: { radius: 2 } },
        scales: {
          x: { ticks: { maxRotation: 45, minRotation: 45 } },
          y: { title: { display: true, text: '°C' } }
        }
      }
    });

    // Make the canvas area taller for readability
    document.getElementById('lineChart').parentElement.style.height = '380px';
  }

  // Wire up refresh button
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('refreshBtn').addEventListener('click', fetchAndRender);
    fetchAndRender(); // initial load
  });
</script>

<style>
  /* tiny helper styles so controls look tidy */
  .controls { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin:10px 0; }
  .controls label { display:flex; gap:6px; align-items:center; }
  .controls button { padding:6px 12px; border-radius:6px; border:1px solid #1f2937; }
</style>
{% endblock %}
